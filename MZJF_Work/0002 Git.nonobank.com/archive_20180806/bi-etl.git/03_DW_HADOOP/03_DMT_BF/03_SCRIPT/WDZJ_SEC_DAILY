


#新数据
#临时基础表
DROP TABLE IF EXISTS TMP.TMP_IDW_DAILY_BASE_DATA;
CREATE TABLE TMP.TMP_IDW_DAILY_BASE_DATA AS 
SELECT 
     bo.id as bo_id,
     substr(bo.bo_title,1,50) as bo_title,
     '100' as schedule ,
     CONCAT(bp.bp_rate_lender,'%') as interest_rate,
     0 as reward,
     case when bo.bo_expect_cat = 2 then '月'
        else '天' END as deadline_unit,
     bo.bo_expect as deadline,
     bo.bo_price as bo_price,
     bo.bp_id as bp_id,
     bo.p_id as p_id,
      CASE WHEN bo.bo_paytype = "DQHBFX"
        THEN 1
      WHEN bo.bo_paytype = "DBDX"
        THEN 2
      WHEN bo.bo_paytype = "XXHB"
        THEN 9
      WHEN bo.bo_paytype = "ZYHK"
        THEN 9
      ELSE 2 END repayment_type,
     case when ui.hj_province_name like '%省' then regexp_replace(ui.hj_province_name,'省','')
     WHEN ui.hj_province_name like '%市' then regexp_replace(ui.hj_province_name,'市','')
     WHEN ui.hj_province_name like '%省' then regexp_replace(ui.hj_province_name,'省','')
     WHEN ui.hj_province_name like '%维吾尔自治区' then regexp_replace(ui.hj_province_name,'维吾尔自治区','')
     WHEN ui.hj_province_name like '%回族自治区' then regexp_replace(ui.hj_province_name,'回族自治区','')
     WHEN ui.hj_province_name like '%壮族自治区' then regexp_replace(ui.hj_province_name,'壮族自治区','')
     WHEN ui.hj_province_name like '%自治区' then regexp_replace(ui.hj_province_name,'自治区','')
     WHEN ui.hj_province_name like '%特别行政区' then regexp_replace(ui.hj_province_name,'特别行政区','')
     WHEN ui.hj_province_name IS NULL then '省'
     ELSE ui.hj_province_name END as province,
     if(ui.hj_city_name is null , '市',ui.hj_city_name ) as city,
     bo.user_id as user_name,
     '' as amount_used_desc, 
     'http://www.nonobank.com' as loan_url, 
     0 as is_agency,
     bo.bo_finish_time as bo_finish_time,
     bo.publish_time as publish_time,
     FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd') AS huiliu_time
from 
  ODS.t_borrows_hist bo
  INNER JOIN ODS.t_borrows_prepare_hist bp ON bo.bp_id = bp.id
  LEFT JOIN idw.user_info ui  ON bo.user_id = ui.user_id 
where 
  ui.stat_date = FROM_UNIXTIME(UNIX_TIMESTAMP() - 1 * 24 * 60 * 60, 'yyyy-MM-dd')
  AND bo.bo_finish_time >= '{LAST_DATA_TIME}'
  AND bo.bo_finish_time < '{T}'
  AND bo.bo_is_finish = 1 
  AND bo.id <>2975806;
 








DROP TABLE IF EXISTS TMP.TMP_IDW_DAILY_V3_SUM_INVT;
CREATE TABLE TMP.TMP_IDW_DAILY_V3_SUM_INVT AS 
SELECT
 dbl.bo_id,
 sum(dbl.price) invest,
 max(dbl.pay_time) last_pay_time,
 min(ds.expect) min_expect,
 min(ds.create_time) min_publish_time
FROM ODS.t_debt_buy_log_hist dbl
 INNER JOIN ODS.t_debt_sale_hist ds ON dbl.ds_id = ds.id
WHERE dbl.pay_time >= '{LAST_DATA_TIME}'
  AND dbl.pay_time < '{T}'
  AND dbl.p_type IN (0, 1, 3) AND dbl.status = 1
GROUP BY dbl.bo_id,to_date(dbl.pay_time);



INSERT OVERWRITE TABLE DMT_BF.WDZJ_BO_INFO PARTITION(STAT_DATE) 
select 
  hbd.bo_id as project_id,
  hbd.bo_title as title,
  hbd.bo_price as amount,
  hbd.schedule as schedule,
  hbd.interest_rate as interest_rate,
  hbd.deadline as deadline,
  hbd.deadline_unit as deadline_unit,
  hbd.reward as reward,
  case when hbd.p_id= 96 then '消费贷'
  ELSE '信用标' END as type, 
  hbd.repayment_type as repayment_type,
  hbd.province as province,
  hbd.city as city,
  hbd.user_name as user_name,
  hbd.amount_used_desc as amount_used_desc,
  hbd.loan_url as loan_url,
  from_unixtime(unix_timestamp(hbd.bo_finish_time ,'yyyy-MM-dd HH:mm:ss.s'),'yyyy-MM-dd HH:mm:ss') as success_time,
  from_unixtime(unix_timestamp(hbd.publish_time,'yyyy-MM-dd HH:mm:ss.s'),'yyyy-MM-dd HH:mm:ss') as publish_time,
  hbd.is_agency as is_agency,
  hbd.bo_id  as bo_id,
  1 as bo_type,
  hbd.p_id,
  to_date(hbd.bo_finish_time) as huiliu_time,
  0 as is_delete,
  'SYS' AS DW_CREATE_BY,
  FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') AS DW_CREATE_TIME,
  'SYS' AS DW_UPDATE_BY,
  FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd') AS DW_UPDATE_TIME,
  to_date(hbd.bo_finish_time) as STAT_DATE
from 
  TMP.TMP_IDW_DAILY_BASE_DATA hbd
union all
select 
  CONCAT(cast(bo.id as string),'_',to_date(dvsi.last_pay_time)) as project_id,
  substr(bo.bo_title,1,50) as title,
  dvsi.invest as amount,
  '100' as schedule ,
  CONCAT(bp.bp_rate_lender,'%') as interest_rate,
  dvsi.min_expect as deadline,
  case when bo.bo_expect_cat = 2 then '月'
  else '天' END as deadline_unit,
  0 as reward,
  '债转标' AS type,
  CASE WHEN bo.bo_paytype = "DQHBFX"
        THEN 1
      WHEN bo.bo_paytype = "DBDX"
        THEN 2
      WHEN bo.bo_paytype = "XXHB"
        THEN 9
      WHEN bo.bo_paytype = "ZYHK"
        THEN 9
      ELSE 2 END repayment_type,
  case when ui.hj_province_name like '%省' then regexp_replace(ui.hj_province_name,'省','')
     WHEN ui.hj_province_name like '%市' then regexp_replace(ui.hj_province_name,'市','')
     WHEN ui.hj_province_name like '%省' then regexp_replace(ui.hj_province_name,'省','')
     WHEN ui.hj_province_name like '%维吾尔自治区' then regexp_replace(ui.hj_province_name,'维吾尔自治区','')
     WHEN ui.hj_province_name like '%回族自治区' then regexp_replace(ui.hj_province_name,'回族自治区','')
     WHEN ui.hj_province_name like '%壮族自治区' then regexp_replace(ui.hj_province_name,'壮族自治区','')
     WHEN ui.hj_province_name like '%自治区' then regexp_replace(ui.hj_province_name,'自治区','')
     WHEN ui.hj_province_name like '%特别行政区' then regexp_replace(ui.hj_province_name,'特别行政区','')
     WHEN ui.hj_province_name IS NULL then '省'
     ELSE ui.hj_province_name END as province,
  if(ui.hj_city_name is null , '市',ui.hj_city_name ) as city,
  bo.user_id as user_name,
  '' as amount_used_desc,
  'http://www.nonobank.com' as loan_url,
  from_unixtime(unix_timestamp(dvsi.last_pay_time ,'yyyy-MM-dd HH:mm:ss.s'),'yyyy-MM-dd HH:mm:ss') as success_time,
  from_unixtime(unix_timestamp(dvsi.min_publish_time,'yyyy-MM-dd HH:mm:ss.s'),'yyyy-MM-dd HH:mm:ss') as publish_time,
  0 as is_agency,
  bo.id  as bo_id,
  2 as bo_type,
  bo.p_id,
  to_date(dvsi.last_pay_time) as huiliu_time,
  0 as is_delete,
  'SYS' AS DW_CREATE_BY,
  FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') AS DW_CREATE_TIME,
  'SYS' AS DW_UPDATE_BY,
  FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd') AS DW_UPDATE_TIME,
  to_date(dvsi.last_pay_time) as STAT_DATE
from 
  TMP.TMP_IDW_DAILY_V3_SUM_INVT dvsi
  INNER JOIN ODS.t_borrows_hist bo on bo.id=dvsi.bo_id
  INNER JOIN ODS.t_borrows_prepare_hist bp ON bo.bp_id = bp.id
  LEFT JOIN idw.user_info ui  ON bo.user_id = ui.user_id
  where 
  ui.stat_date = FROM_UNIXTIME(UNIX_TIMESTAMP() - 1 * 24 * 60 * 60, 'yyyy-MM-dd')
  AND dvsi.bo_id not in  (select bo_id from dmt_bf.wdzj_npl_bo_legacy);




INSERT OVERWRITE TABLE DMT_BF.WDZJ_DEBT_INFO PARTITION(STAT_DATE)
SELECT
  CASE WHEN p_type = 2 THEN cast(dbl.bo_id as string)
    ELSE CONCAT(cast(dbl.bo_id as string),'_',to_date(dbl.pay_time)) END AS project_id,
  dbl.user_id as subscribe_user_name,
  dbl.price as amount,
  dbl.price as valid_amount,
  from_unixtime(unix_timestamp(dbl.pay_time,'yyyy-MM-dd HH:mm:ss.s'),'yyyy-MM-dd HH:mm:ss') as add_date,
  1 as status,
  0 as type,
  3 as source_type,
  dbl.id as dbl_id,
  to_date(dbl.pay_time) as huiliu_time,
  0 as is_delete,
  'SYS' AS DW_CREATE_BY,
  FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') AS DW_CREATE_TIME,
  'SYS' AS DW_UPDATE_BY,
  FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd') AS DW_UPDATE_TIME,
  to_date(dbl.pay_time) as STAT_DATE
FROM ODS.t_debt_buy_log_hist dbl
WHERE  dbl.pay_time >= '{LAST_DATA_TIME}'
  AND dbl.pay_time < '{T}'
  AND dbl.status = 1;









